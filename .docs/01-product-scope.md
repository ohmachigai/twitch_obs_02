# `.docs/01-product-scope.md` — プロダクト・スコープ定義

> 本書は本リポジトリにおける**機能的／非機能的スコープの一次定義**です。
> 設計・実装・テストは本スコープに準拠します（規範文書）。詳細仕様は `02–12` の各章で補足します。

---

## 1. 目的（Problem → Outcome）

* **問題**

  * 配信者ごとに「チャンネルポイント引き換え → 待機キュー化 → 表示・消化」を**信頼性高く**運用したい。
  * **管理画面の操作（外し/巻戻し）**や**自動ポリシー（60秒以内の連打は消費）**が**再読み込みや再起動後も正しく保持**されてほしい。
  * **OBS オーバーレイのデザイン切替**は**フロントのみ**で完結させたい（URL/制御イベントで切替）。
  * **履歴＋ライブ更新**を同時に扱い、**状態の欠落や二重反映をなくす**必要がある。

* **成果**

  * **多テナント**（配信者単位で完全分離）の**イベント中継・待機キュー管理システム**を提供。
  * **初期スナップショット（REST）＋増分（SSE）**で**冪等・再現性**を担保。
  * **CommandLog（append-only, version 単調増加）**を唯一の真実として、**差分（パッチ）**で UI を更新。
  * **デザイン切替はフロントのみ**で実現（テーマパックとURLクエリ）。
  * **72時間保持**の実運用（EventRaw/CommandLog）、**Queue/Counters/Settings は永続**。

---

## 2. ペルソナ / ロール

* **Broadcaster（配信者）**：自身のチャンネルに対する設定・管理（デザイン・反スパム・キュー運用）。
* **Operator（配信補助／モデレーター）**：配信者に付与された権限で**キュー操作（外し/巻戻し）**。
* **Superadmin（特権管理者）**：ユーザ作成・環境設定・障害対応。
* **Viewer**：本システムの直接ユーザではない（オーバーレイを見る側）。

---

## 3. インスコープ（MVP で必ず提供する機能）

### 3.1 多テナント・分離

* 配信者（broadcaster）単位で**データ・設定・認可**を完全分離。
* API/SSE すべてが `broadcaster` コンテキストで評価される。

### 3.2 イベント取得と正規化

* **Twitch EventSub（Webhook）**で取得：署名（HMAC-SHA256）、±10分検証、Message-Id 冪等、**204 即 ACK**。
* 対象（MVP 基本）：

  * **チャンネルポイント** `channel.channel_points_custom_reward_redemption.add|update`
  * **配信状態** `stream.online|offline`（“配信内”の境界に使用）

### 3.3 キュー管理（ドメイン規則）

* **対象リワード**の引き換えで**QueueEntry を必ず記録・待機列へ追加**。
* **反スパム**：**同一ユーザ × 同一リワード × 60秒内**の2回目以降は**消費（consume）**、それ以外は**返金（refund）**。

  * 返金/消費は **Helix** で更新可能な場合のみ実施（**自アプリ作成リワードに限る**）。
* **“今日引き換えた回数”**を**配信者のタイムゾーン**でカウント（TZ の 0:00 が境界）。
* **優先度**：**今日の回数が少ない順 → 先着**。
* **配信開始時クリア**：`stream.online` で**キューを一括クリア**するかは配信者設定で切替（既定：ON）。
* **管理操作**：

  * **COMPLETE**＝「並び終わり」：キュー完了、**回数は変化なし**。
  * **UNDO**＝「巻き戻し」：キューから除去、**“今日の回数”を 1 減らす**。
  * いずれも**永続記録**し、**差分配信**の対象とする。

### 3.4 表示（OBS オーバーレイ）

* **REST `/api/state`（初期）＋ SSE `/overlay/sse`（増分）**で表示更新。
* **デザイン切替**：URLクエリ（`?theme=&variant=&accent=&group_size=`）と**テーマパック**（CSS/JSON）でフロントのみ完結。
* **グループ表示**：`group_size` 単位での見せ方は**フロントの表現**として実装（サーバのキュー構造は変えない）。
* 表示には**ユーザ名・アイコン**を含める（CSS で見た目調整可能）。

### 3.5 冪等性・再現性・保持

* **CommandLog（append-only, version 単調増加）**を**一次ソース**に。
* SSE の **`id=version`**、**20–30秒心拍**、**リング再送**で**欠落を補償**。
* **EventRaw/CommandLog は 72時間保持**、**Queue/Counters/Settings は永続**。
* 再起動・再読み込み後も、**初期REST＋増分SSE**で**同じ状態に復元**。

### 3.6 観測とデバッグ（MVP 必須面）

* **Stage Tap（SSE）**：`ingress → policy → command → projector → sse` をリアルタイム可視化。
* **構造化ログ（tracing）/メトリクス（Prometheus）**：最小セットを計測。
* **Capture/Replay**：再現可能な NDJSON を取得・適用（決定性の担保）。

  > 詳細は `07-debug-telemetry.md`。

### 3.7 ユーザ・認証・OAuth

* **ユーザ作成**は当初 **Superadmin の管理画面のみ**。
* 各ユーザは**自分のパスワード変更**可。
* **Twitch OAuth** は Web 上でいつでもやり直し可。連携済みの配信者のみ**購読を維持／復旧**。
* **SSE 認可**は**短寿命署名トークン（クエリ or 同一オリジン Cookie）**。

---

## 4. アウトオブスコープ（MVP では扱わない）

* WebSocket 方式の EventSub 取得（Webhook 固定）／Conduits の本格運用。
* 高度な演出エディタ／複雑なアニメーションデザイナ。
* 分散クラスタ／外部キューブローカー（NATS/Redis 等）への移行。
* 大規模分析基盤や BI 連携。
* 汎用チャットボット／全チャット機能の完全再実装。
* 支払い・課金機能。
* PII/GDPR 監査の包括的運用（最小限のマスクのみ対応）。

---

## 5. 成功基準（受け入れの観点・MVP）

1. **配信者 A が OAuth 連携** → **対象リワードの redemption** が来る → **QueueEntry 記録**・**ポリシー（refund/consume）**適用 → **SSE で overlay/admin 同期**。
2. **管理画面で COMPLETE/UNDO** → **CommandLog に記録** → **Queue/Counters 更新** → **SSE パッチ配信** → **再読み込みしても結果が保持**。
3. **OBS/サーバを再起動** → **REST 初期取得 → SSE 追随**で**欠落なく復元**。
4. **配信開始時クリア**の設定が機能（ON/OFF 切替）。
5. **反スパム**（60s 連打＝consume）が正しく発火（境界 59s/61s で差異）。
6. **デザイン切替**（URLクエリ／制御イベント）が即時反映。
7. `/_debug/tap` と `/metrics` で**処理段階と計測**が確認可能。
8. **EventRaw/CommandLog の TTL（72h）が動作**し、Queue/Counters/Settings は変化しない。

---

## 6. 品質特性（非機能要件・SLO 目安）

* **信頼性**：Webhook **ACK p95 < 200ms**（署名/冪等のみで返す）、SSE ブロードキャスト **p95 < 50ms**。
* **可観測性**：Stage Tap、構造化ログ、Prometheus メトリクスが常時有効（本番は権限保護）。
* **移植性**：開発は **Linux/Windows** で同一手順、DB は **SQLite(WAL)**（追加サービス不要）。
* **運用**：本番の TLS/Nginx にて SSE パスは `proxy_buffering off`、NTP 同期前提。
* **セキュリティ**：短寿命トークンによる SSE 認可、PII は既定マスク、Secrets はファイル/環境変数管理。

---

## 7. 制約・前提

* **Helix の制約**：**Redemption の更新は、自アプリが作成したリワードに限定**（ダッシュボード作成は読み取りのみ）。
* **“今日”の定義**：配信者設定のタイムゾーンで日付境界を決定。内部保存は UTC。
* **EventSub**：**Webhook 固定**（WebSocket/Conduits は将来検討）。
* **初期+増分**：**REST `/api/state` → SSE** の二段設計に準拠（EventSource はカスタムヘッダ不可のため、初回のみクエリで `since_version`）。

---

## 8. ユースケース（代表）

1. **参加型タイトルの入隊キュー**

   * 視聴者が対象リワードを引き換え → キューに入る → 管理画面で順次 COMPLETE → Overlay に表示。
2. **荒らし対策**

   * 同一ユーザが短時間に連打 → 2 回目以降は自動消費（返金しない） → キューの健全化。
3. **配信切替の即応**

   * 配信開始でキュー自動クリア（ON/OFF 切替可） → 新しいセッションへ。
4. **デザイン即時切替**

   * 配信中にテーマ（色・フォント・レイアウト）を切替 → 視覚演出を最小コストで変更。

---

## 9. 依存関係（外部）

* **Twitch EventSub / Helix**（OAuth、Subscription、Redemption 更新・Backfill 取得）
* **OBS Browser Source（CEF）**：モダン Web API（ESM/CSS 変数/EventSource）が利用可能。
* **本番のみ Nginx**：TLS 終端、SSE のバッファ無効化。

---

## 10. リスクと方針

* **ヘルス低下（購読失効）**：自動再購読・`/oauth2/validate` 周期チェック・Backfill。
* **欠落・二重反映**：`Message-Id` 冪等、`id=version` SSE、初期RESTの整合。
* **負荷の偏在**：SSE のリング再送・types フィルタで帯域最適化。
* **人為的誤操作**：`op_id` 冪等と Capture/Replay による復元・検証。

---

## 11. 参照（どこに詳細があるか）

* **アーキテクチャ / データフロー**：`02-architecture-overview.md`
* **ドメインモデル / 不変条件**：`03-domain-model.md`
* **API（REST/SSE/Mutation/Debug）**：`04-api-contracts.md`
* **データスキーマ / TTL / WAL**：`05-data-schema-and-migrations.md`
* **フロント仕様（テーマ・URL・表示）**：`06-frontend-spec.md`
* **デバッグ/観測**：`07-debug-telemetry.md`
* **PR 計画 / 受入基準**：`08-implementation-plan.md`
* **テスト戦略**：`09-testing-strategy.md`
* **運用**：`10-operations-runbook.md`
* **セキュリティ/プライバシ**：`11-security-and-privacy.md`
* **CI/CD**：`12-ci-cd.md`

---

本スコープは**規範**です。実装で発見された事実と矛盾が生じた場合は、**事実に合わせて本書を更新**し、関連章（`02–12`）の整合を取ってください。
